================================================================================
ORKESTRAI API - CONFIGURA√á√ÉO DE DEPLOY COMPLETA ‚úÖ
================================================================================

Data: $(date)
Sistema: GitHub Actions + Google Cloud E2 + Docker

================================================================================
üì¶ ARQUIVOS CRIADOS
================================================================================

DOCKER & CONTAINERIZA√á√ÉO:
  ‚úì Dockerfile                      - Imagem Docker multi-stage otimizada
  ‚úì .dockerignore                   - Exclus√µes do build Docker
  ‚úì docker-compose.prod.yml         - Compose para produ√ß√£o completo

GITHUB ACTIONS WORKFLOWS:
  ‚úì .github/workflows/deploy.yml           - Deploy autom√°tico na E2
  ‚úì .github/workflows/ci.yml               - CI/testes em PRs
  ‚úì .github/workflows/backup.yml           - Backup di√°rio autom√°tico
  ‚úì .github/workflows/security-scan.yml    - Scan de seguran√ßa semanal
  ‚úì .github/PULL_REQUEST_TEMPLATE.md       - Template para PRs

SCRIPTS DE GERENCIAMENTO:
  ‚úì scripts/setup_gcp_server.sh     - Setup inicial do servidor E2
  ‚úì scripts/deploy_manual.sh        - Deploy manual (sem GitHub Actions)
  ‚úì scripts/check_server_status.sh  - Verificar status dos servi√ßos
  ‚úì scripts/backup_db.sh            - Backup do banco de dados
  ‚úì scripts/test_deploy_config.sh   - Testar configura√ß√£o antes do deploy
  ‚úì scripts/setup_https.sh          - Configurar HTTPS com Let's Encrypt
  ‚úì scripts/rollback.sh             - Fazer rollback para vers√£o anterior
  ‚úì scripts/monitor_logs.sh         - Monitor interativo de logs

DOCUMENTA√á√ÉO:
  ‚úì docs/DEPLOY_SETUP.md            - Guia completo (30 min)
  ‚úì docs/FAQ_DEPLOY.md              - FAQ e troubleshooting
  ‚úì DEPLOY_README.md                - Overview do sistema de deploy
  ‚úì QUICKSTART_DEPLOY.md            - In√≠cio r√°pido (10 min)
  ‚úì RESUMO_CONFIGURACAO_DEPLOY.md   - Resumo e refer√™ncia r√°pida
  ‚úì CONFIGURACAO_COMPLETA.txt       - Este arquivo

CONFIGURA√á√ÉO:
  ‚úì env.template                    - Template de vari√°veis de ambiente
  ‚úì nginx.conf.template             - Config Nginx para HTTPS
  ‚úì .gitignore                      - Atualizado com exclus√µes relevantes
  ‚úì README.md                       - Atualizado com se√ß√£o de deploy

================================================================================
üéØ FUNCIONALIDADES IMPLEMENTADAS
================================================================================

1. ‚úÖ DEPLOY AUTOM√ÅTICO
   - Push para main/master ‚Üí Deploy autom√°tico
   - Build Docker otimizado
   - Transfer seguro via SSH
   - Health check p√≥s-deploy
   - Notifica√ß√µes de status

2. ‚úÖ CI/CD COMPLETO
   - Testes em PRs
   - Lint (flake8, black, isort)
   - Build Docker de teste
   - Verifica√ß√µes de qualidade

3. ‚úÖ BACKUP AUTOM√ÅTICO
   - Backup di√°rio √†s 3h UTC
   - Compress√£o autom√°tica
   - Reten√ß√£o de 7 backups
   - Logs de execu√ß√£o

4. ‚úÖ SECURITY SCAN
   - Scan semanal de vulnerabilidades
   - An√°lise de c√≥digo (Bandit)
   - Scan de containers (Trivy)
   - Detec√ß√£o de secrets (TruffleHog)
   - Relat√≥rios em Security tab

5. ‚úÖ SCRIPTS DE GERENCIAMENTO
   - Setup inicial do servidor
   - Deploy manual
   - Status dos servi√ßos
   - Backup do banco
   - Configura√ß√£o HTTPS
   - Rollback
   - Monitor de logs

6. ‚úÖ DOCUMENTA√á√ÉO COMPLETA
   - Guia passo a passo
   - FAQ e troubleshooting
   - In√≠cio r√°pido
   - Refer√™ncia de comandos

================================================================================
üîê SECRETS NECESS√ÅRIOS (GitHub)
================================================================================

Configure em: Settings ‚Üí Secrets and variables ‚Üí Actions

  1. GCP_HOST          = IP da m√°quina E2 (ex: 34.123.45.67)
  2. GCP_USERNAME      = Usu√°rio SSH (ex: seu_usuario)
  3. GCP_SSH_KEY       = Chave privada SSH (conte√∫do completo)
  4. GCP_SSH_PORT      = 22 (opcional, se usar porta diferente)

Gerar chave SSH:
  ssh-keygen -t ed25519 -C "github-actions" -f ~/.ssh/gcp_deploy_key
  
Copiar chave p√∫blica para servidor:
  cat ~/.ssh/gcp_deploy_key.pub | ssh usuario@ip "cat >> ~/.ssh/authorized_keys"

================================================================================
‚öôÔ∏è CONFIGURA√á√ÉO DO SERVIDOR E2
================================================================================

PASSO 1 - SETUP INICIAL:
  # Na m√°quina E2
  wget https://raw.githubusercontent.com/USER/REPO/main/scripts/setup_gcp_server.sh
  chmod +x setup_gcp_server.sh
  ./setup_gcp_server.sh
  
  # Fazer logout e login novamente
  exit

PASSO 2 - CONFIGURAR .ENV:
  cd ~/orkestrai-api
  cp env.template .env
  nano .env
  
  # Configurar vari√°veis obrigat√≥rias:
  - POSTGRES_PASSWORD
  - REDIS_PASSWORD
  - SECRET_KEY
  - GOOGLE_API_KEY
  - OPENAI_API_KEY

PASSO 3 - FIREWALL GOOGLE CLOUD:
  # Via CLI
  gcloud compute firewall-rules create allow-orkestrai-api \
      --allow tcp:8001 \
      --source-ranges 0.0.0.0/0
  
  # Ou via Console Web: VPC Network ‚Üí Firewall ‚Üí CREATE FIREWALL RULE

================================================================================
üöÄ COMO USAR
================================================================================

PRIMEIRA VEZ:
  1. Configure servidor E2 (ver se√ß√£o acima)
  2. Configure secrets no GitHub
  3. Teste configura√ß√£o: ./scripts/test_deploy_config.sh
  4. Fa√ßa push: git push origin main
  5. Acompanhe: GitHub ‚Üí Actions

DEPLOY CONT√çNUO:
  # Qualquer push para main/master dispara deploy autom√°tico
  git add .
  git commit -m "Suas mudan√ßas"
  git push origin main
  
  # GitHub Actions cuida do resto! üéâ

DEPLOY MANUAL (Sem GitHub Actions):
  # Na m√°quina E2
  cd ~/orkestrai-api
  ./scripts/deploy_manual.sh

VERIFICAR STATUS:
  ssh usuario@ip
  cd ~/orkestrai-api
  ./scripts/check_server_status.sh

FAZER BACKUP:
  ./scripts/backup_db.sh

CONFIGURAR HTTPS:
  sudo ./scripts/setup_https.sh

ROLLBACK:
  ./scripts/rollback.sh

MONITORAR LOGS:
  ./scripts/monitor_logs.sh

================================================================================
üìä WORKFLOWS CONFIGURADOS
================================================================================

1. DEPLOY AUTOM√ÅTICO (deploy.yml)
   Trigger: Push para main/master ou manual
   A√ß√µes:
   - Build imagem Docker
   - Transfer para m√°quina E2
   - Parar containers antigos
   - Carregar nova imagem
   - Iniciar servi√ßos
   - Executar migra√ß√µes
   - Iniciar aplica√ß√£o
   - Health check
   - Limpeza de imagens antigas

2. CI - TESTES (ci.yml)
   Trigger: Pull requests e pushes em outras branches
   A√ß√µes:
   - Lint com flake8
   - Check formata√ß√£o (black)
   - Check imports (isort)
   - Build Docker de teste
   - Verificar tamanho da imagem

3. BACKUP AUTOM√ÅTICO (backup.yml)
   Trigger: Diariamente √†s 3h UTC ou manual
   A√ß√µes:
   - Backup PostgreSQL
   - Compress√£o
   - Reten√ß√£o de 7 backups
   - Listar backups dispon√≠veis

4. SECURITY SCAN (security-scan.yml)
   Trigger: Semanalmente (domingo 2h UTC) ou manual
   A√ß√µes:
   - Scan com Safety (depend√™ncias)
   - Scan com Bandit (c√≥digo)
   - Scan com Trivy (containers)
   - Detec√ß√£o de secrets (TruffleHog)
   - Upload de relat√≥rios

================================================================================
üåê ACESSOS P√ìS-DEPLOY
================================================================================

API:
  http://SEU_IP:8001

Documenta√ß√£o (Swagger):
  http://SEU_IP:8001/docs

Com HTTPS (ap√≥s configurar):
  https://seu-dominio.com
  https://seu-dominio.com/docs

Health Check:
  curl http://SEU_IP:8001/docs

================================================================================
üîß COMANDOS √öTEIS
================================================================================

DOCKER:
  docker ps                           # Ver containers rodando
  docker logs -f orkestrai-api        # Logs em tempo real
  docker stats                        # Uso de recursos
  docker restart orkestrai-api        # Reiniciar aplica√ß√£o
  docker system prune -a -f           # Limpar espa√ßo

BANCO DE DADOS:
  docker exec -it agents_postgres psql -U agentuser -d agentsdb
  docker exec agents_postgres pg_dump -U agentuser agentsdb > backup.sql

NGINX (se configurado):
  sudo systemctl status nginx         # Status
  sudo systemctl reload nginx         # Recarregar config
  sudo nginx -t                       # Testar config
  sudo certbot renew                  # Renovar SSL

SISTEMA:
  df -h                              # Espa√ßo em disco
  free -h                            # Mem√≥ria
  htop                               # Monitor de recursos
  netstat -tlnp                      # Portas em uso

================================================================================
üìñ GUIAS DE REFER√äNCIA
================================================================================

ESCOLHA O GUIA ADEQUADO:

1. GUIA COMPLETO (30 min) - docs/DEPLOY_SETUP.md
   - Explica√ß√£o detalhada de cada passo
   - Configura√ß√£o de HTTPS
   - Troubleshooting avan√ßado
   - Recomenda√ß√µes de seguran√ßa

2. IN√çCIO R√ÅPIDO (10 min) - QUICKSTART_DEPLOY.md
   - Setup em 10 minutos
   - Comandos diretos
   - M√≠nimo de explica√ß√µes

3. OVERVIEW GERAL - DEPLOY_README.md
   - Vis√£o geral do sistema
   - Arquivos criados
   - Comandos √∫teis

4. FAQ - docs/FAQ_DEPLOY.md
   - Perguntas frequentes
   - Troubleshooting comum
   - Problemas e solu√ß√µes

5. RESUMO - RESUMO_CONFIGURACAO_DEPLOY.md
   - Lista de arquivos criados
   - Refer√™ncia r√°pida
   - Estrutura do projeto

================================================================================
üêõ TROUBLESHOOTING R√ÅPIDO
================================================================================

CONTAINER N√ÉO INICIA:
  docker logs orkestrai-api
  docker logs --tail 100 orkestrai-api
  ./scripts/check_server_status.sh

DEPLOY FALHA NO GITHUB ACTIONS:
  1. Verificar secrets no GitHub
  2. Testar SSH: ssh -i chave usuario@ip
  3. Ver logs do workflow no GitHub Actions
  4. Verificar espa√ßo em disco: df -h

API N√ÉO RESPONDE:
  docker restart orkestrai-api
  curl http://localhost:8001/docs
  ./scripts/check_server_status.sh

SEM ESPA√áO EM DISCO:
  docker system prune -a -f
  docker volume prune -f
  df -h

BANCO N√ÉO CONECTA:
  docker logs agents_postgres
  docker restart agents_postgres
  docker exec agents_postgres pg_isready

================================================================================
‚úÖ CHECKLIST P√ìS-DEPLOY
================================================================================

  [ ] API responde em http://IP:8001/docs
  [ ] Logs n√£o mostram erros cr√≠ticos
  [ ] Banco de dados acess√≠vel
  [ ] Redis funcionando
  [ ] Backup autom√°tico configurado
  [ ] Firewall configurado (porta 8001)
  [ ] Secrets do GitHub configurados
  [ ] .env na m√°quina E2 configurado
  [ ] Deploy autom√°tico testado
  [ ] HTTPS configurado (opcional mas recomendado)

================================================================================
üìö RECURSOS ADICIONAIS
================================================================================

Documenta√ß√£o:
  - GitHub Actions: https://docs.github.com/actions
  - Docker: https://docs.docker.com/
  - FastAPI: https://fastapi.tiangolo.com/deployment/
  - Google Cloud E2: https://cloud.google.com/compute/docs/machine-types
  - Nginx: https://nginx.org/en/docs/
  - Let's Encrypt: https://letsencrypt.org/

Ferramentas:
  - Docker Hub: https://hub.docker.com/
  - GitHub Actions Marketplace: https://github.com/marketplace?type=actions

================================================================================
üéâ CONCLUS√ÉO
================================================================================

‚úÖ Sistema de CI/CD COMPLETO configurado!

Cada push para main/master dispara deploy autom√°tico na sua m√°quina E2.

Recursos implementados:
  ‚úì Deploy autom√°tico
  ‚úì CI/CD com testes
  ‚úì Backup di√°rio
  ‚úì Scan de seguran√ßa
  ‚úì Scripts de gerenciamento
  ‚úì Documenta√ß√£o completa
  ‚úì Rollback
  ‚úì Monitoramento
  ‚úì HTTPS (via script)

Pr√≥ximos passos recomendados:
  1. Testar deploy autom√°tico
  2. Configurar HTTPS com dom√≠nio personalizado
  3. Configurar monitoramento (Prometheus + Grafana)
  4. Implementar backup para Cloud Storage
  5. Configurar alertas

================================================================================

Para mais informa√ß√µes, consulte os guias em:
  - docs/DEPLOY_SETUP.md
  - QUICKSTART_DEPLOY.md
  - DEPLOY_README.md
  - docs/FAQ_DEPLOY.md

================================================================================

